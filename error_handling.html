<!DOCTYPE HTML>
<html lang="en-US" manifest="./manifest.appcache">
    
    <head>
        
        <meta charset="UTF-8">
        <title>Error Handling | 介绍</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 0.7.1">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <meta name="author" content="CodeFalling">
    
    
    <link rel="next" href="./s_expressions.html" />
    
    
    <link rel="prev" href="./evaluation.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="gitbook/style.css">


        
    <div class="book" data-github="CodeFalling/BuildYourOwnLispGitbookCN" data-level="7" data-basepath="." data-revision="1408641508973">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/CodeFalling/BuildYourOwnLispGitbookCN" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="./" >介绍</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        <li>
            <a href="https://github.com/CodeFalling" target="blank" class="author-link">About the author</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/CodeFalling/BuildYourOwnLispGitbookCN/issues" target="blank" class="issues-link">Questions and Issues</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/CodeFalling/BuildYourOwnLispGitbookCN/edit/master/error_handling.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

	

        
        <li class="divider"></li>
        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="installation.html">
            
                
                    <a href="./installation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Installation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="basics.html">
            
                
                    <a href="./basics.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Basics
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="interactive_prompt.html">
            
                
                    <a href="./interactive_prompt.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Interactive Prompt
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="languages.html">
            
                
                    <a href="./languages.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Languages
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="parsing.html">
            
                
                    <a href="./parsing.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Parsing
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="evaluation.html">
            
                
                    <a href="./evaluation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         Evaluation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="7" data-path="error_handling.html">
            
                
                    <a href="./error_handling.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         Error Handling
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="s_expressions.html">
            
                
                    <a href="./s_expressions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         S-Expressions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="q_expressions.html">
            
                
                    <a href="./q_expressions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         Q-Expressions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="variables.html">
            
                
                    <a href="./variables.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         Variables
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="functions.html">
            
                
                    <a href="./functions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         Functions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="conditionals.html">
            
                
                    <a href="./conditionals.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         Conditionals
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="strings.html">
            
                
                    <a href="./strings.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         Strings
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="standard_library.html">
            
                
                    <a href="./standard_library.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         Standard Library
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="bonus_projects.html">
            
                
                    <a href="./bonus_projects.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         Bonus Projects
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="faq.html">
            
                
                    <a href="./faq.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         FAQ
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="credits.html">
            
                
                    <a href="./credits.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         Credits
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 41.1764705882353%;min-width: 35.294117647058826%;"></div>
    </div>
    <div class="chapters">
    
        <a href="./index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="./installation.html" title="Installation" class="chapter done new-chapter" data-progress="1" style="left: 5.882352941176471%;"></a>
    
        <a href="./basics.html" title="Basics" class="chapter done new-chapter" data-progress="2" style="left: 11.764705882352942%;"></a>
    
        <a href="./interactive_prompt.html" title="Interactive Prompt" class="chapter done new-chapter" data-progress="3" style="left: 17.647058823529413%;"></a>
    
        <a href="./languages.html" title="Languages" class="chapter done new-chapter" data-progress="4" style="left: 23.529411764705884%;"></a>
    
        <a href="./parsing.html" title="Parsing" class="chapter done new-chapter" data-progress="5" style="left: 29.41176470588235%;"></a>
    
        <a href="./evaluation.html" title="Evaluation" class="chapter done new-chapter" data-progress="6" style="left: 35.294117647058826%;"></a>
    
        <a href="./error_handling.html" title="Error Handling" class="chapter done new-chapter" data-progress="7" style="left: 41.1764705882353%;"></a>
    
        <a href="./s_expressions.html" title="S-Expressions" class="chapter  new-chapter" data-progress="8" style="left: 47.05882352941177%;"></a>
    
        <a href="./q_expressions.html" title="Q-Expressions" class="chapter  new-chapter" data-progress="9" style="left: 52.94117647058823%;"></a>
    
        <a href="./variables.html" title="Variables" class="chapter  " data-progress="10" style="left: 58.8235294117647%;"></a>
    
        <a href="./functions.html" title="Functions" class="chapter  " data-progress="11" style="left: 64.70588235294117%;"></a>
    
        <a href="./conditionals.html" title="Conditionals" class="chapter  " data-progress="12" style="left: 70.58823529411765%;"></a>
    
        <a href="./strings.html" title="Strings" class="chapter  " data-progress="13" style="left: 76.47058823529412%;"></a>
    
        <a href="./standard_library.html" title="Standard Library" class="chapter  " data-progress="14" style="left: 82.3529411764706%;"></a>
    
        <a href="./bonus_projects.html" title="Bonus Projects" class="chapter  " data-progress="15" style="left: 88.23529411764706%;"></a>
    
        <a href="./faq.html" title="FAQ" class="chapter  " data-progress="16" style="left: 94.11764705882354%;"></a>
    
        <a href="./credits.html" title="Credits" class="chapter  " data-progress="17" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_7">
                    
                        <h1 id="error-handling">Error Handling</h1>
<h2 id="crashes">Crashes</h2>
<p>Some of you may have noticed a problem with the previous chapter&#39;s program. Try entering this into the prompt and see what happens.</p>
<pre><code class="lang-lispy">Lispy Version 0.0.0.0.3
Press Ctrl+c to Exit

lispy&gt; / 10 0
</code></pre>
<p>Ouch. The program crashed upon trying to divide by zero. It&#39;s okay if a program crashes during development, but our final program would hopefully never crash, and always explain to the user what went wrong.</p>
<p>At the moment our program can produce syntax errors but it still has no functionality for reporting errors in the evaluation of expressions. We need to build in some kind of error handling functionality to do this. It can be awkward in C, but if we start off on the right track, it will pay off later on when our system gets more complicated.</p>
<h2 id="lisp-value">Lisp Value</h2>
<p>There are several ways to deal with errors in C, but in this context my preferred method is to make errors a possible result of evaluating an expression. Then we can say that, in Lispy, an expression will evaluate to <em>either</em> a <em>number</em>, or an <em>error</em>. For example <code>+ 1 2</code> will evaluate to a number, but <code>/ 10 0</code> will evaluate to an error.</p>
<p>For this we need a data structure that can act as either one thing or anything. For simplicity sake we are just going to use a <code>struct</code> with fields specific to each thing that can be represented, and a special field <code>type</code> to tell us exactly what fields are meaningful to access.</p>
<p>This we are going to call an <code>lval</code>, which stands for <em>Lisp Value</em>.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Declare New lval Struct */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
  <span class="hljs-keyword">int</span> type;
  <span class="hljs-keyword">long</span> num;
  <span class="hljs-keyword">int</span> err;
} lval;
</code></pre>
<h2 id="enumerations">Enumerations</h2>
<p>You&#39;ll notice the type of the fields <code>type</code>, and <code>err</code>, is <code>int</code>. This means they are represented by a single integer number.</p>
<p>The reason we pick <code>int</code> is because we will assign meaning to each integer value, to encode what we require. For example we can make a rule <em>&quot;If <code>type</code> is <code>0</code> then the structure is a Number.&quot;</em>, or <em>&quot;If <code>type</code> is <code>1</code> then the structure is an Error.&quot;</em> This is a good way of doing things. It is simple and effective.</p>
<p>But if we litter our code with stray <code>0</code> and <code>1</code> then it is going to become increasingly unclear as to what is happening. Instead we can use named constants that have been assigned these integer values. This gives the reader an indication as to <em>why</em> one might be comparing a number to <code>0</code> or <code>1</code> and <em>what</em> is meant in this context.</p>
<p>In C this is supported using something called an <code>enum</code>.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Create Enumeration of Possible lval Types */</span>
<span class="hljs-keyword">enum</span> { LVAL_NUM, LVAL_ERR };
</code></pre>
<p>An <code>enum</code> is a declaration of variables which under the hood are automatically assigned integer constant values. Above is how we would declare some enumerated values for the <code>type</code> field.</p>
<p>We also want to declare an enumeration for the <em>error</em> field. We have three error cases in our particular program. There is division by zero, an unknown operator, or being passed a number that is too large to be represented internally using a <code>long</code>. These can be enumerated as follows.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Create Enumeration of Possible Error Types */</span>
<span class="hljs-keyword">enum</span> { LERR_DIV_ZERO, LERR_BAD_OP, LERR_BAD_NUM };
</code></pre>
<h2 id="lisp-value-functions">Lisp Value Functions</h2>
<p>Our <code>lval</code> type is almost ready to go. Unlike the previous <code>long</code> type we have no current method for creating new instances of it. To do this we can declare two functions that construct an <code>lval</code> of either an <em>error</em> type or a <em>number</em> type.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Create a new number type lval */</span>
lval lval_num(<span class="hljs-keyword">long</span> x) {
  lval v;
  v.type = LVAL_NUM;
  v.num = x;
  <span class="hljs-keyword">return</span> v;
}

<span class="hljs-comment">/* Create a new error type lval */</span>
lval lval_err(<span class="hljs-keyword">int</span> x) {
  lval v;
  v.type = LVAL_ERR;
  v.err = x;
  <span class="hljs-keyword">return</span> v;
}
</code></pre>
<p>These functions first create an <code>lval</code> called <code>v</code>, and assign the fields before returning it.</p>
<p>Because our <code>lval</code> function can now be one of two things we can no longer just use <code>printf</code> to output it. We will want to do different behaviour depending upon the type of the <code>lval</code> that is given. There is a concise way to do this in C using the <code>switch</code> statement. This takes some value as input and compares it to other known values, known as <em>cases</em>. When the values are equal it executes the code that follows up until the next <code>break</code> statement.</p>
<p>Using this we can build a function that can print an <code>lval</code> of any type like this.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Print an "lval" */</span>
<span class="hljs-keyword">void</span> lval_print(lval v) {
  <span class="hljs-keyword">switch</span> (v.type) {
    <span class="hljs-comment">/* In the case the type is a number print it, then 'break' out of the switch. */</span>
    <span class="hljs-keyword">case</span> LVAL_NUM: <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%li"</span>, v.num); <span class="hljs-keyword">break</span>;

    <span class="hljs-comment">/* In the case the type is an error */</span>
    <span class="hljs-keyword">case</span> LVAL_ERR:
      <span class="hljs-comment">/* Check What exact type of error it is and print it */</span>
      <span class="hljs-keyword">if</span> (v.err == LERR_DIV_ZERO) { <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error: Division By Zero!"</span>); }
      <span class="hljs-keyword">if</span> (v.err == LERR_BAD_OP)   { <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error: Invalid Operator!"</span>); }
      <span class="hljs-keyword">if</span> (v.err == LERR_BAD_NUM)  { <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error: Invalid Number!"</span>); }
    <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">/* Print an "lval" followed by a newline */</span>
<span class="hljs-keyword">void</span> lval_println(lval v) { lval_print(v); <span class="hljs-built_in">putchar</span>(<span class="hljs-string">'\n'</span>); }
</code></pre>
<h2 id="evaluating-errors">Evaluating Errors</h2>
<p>Now that we know how to work with the <code>lval</code> type, we need to change our evaluation functions to use it instead of <code>long</code>.</p>
<p>As well as changing the type signatures we need to change the functions such that they work correctly upon encountering either an <em>error</em> as input, or a <em>number</em> as input.</p>
<p>In our <code>eval_op</code> function, if we encounter an error we should return it right away, and only do computation if both the arguments are numbers. We should modify our code to return an error rather than attempt to divide by zero. This will fix the crash from right at the beginning of this chapter.</p>
<pre><code class="lang-c">lval eval_op(lval x, <span class="hljs-keyword">char</span>* op, lval y) {

  <span class="hljs-comment">/* If either value is an error return it */</span>
  <span class="hljs-keyword">if</span> (x.type == LVAL_ERR) { <span class="hljs-keyword">return</span> x; }
  <span class="hljs-keyword">if</span> (y.type == LVAL_ERR) { <span class="hljs-keyword">return</span> y; }

  <span class="hljs-comment">/* Otherwise do maths on the number values */</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"+"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> lval_num(x.num + y.num); }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"-"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> lval_num(x.num - y.num); }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"*"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> lval_num(x.num * y.num); }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"/"</span>) == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">/* If second operand is zero return error instead of result */</span>
    <span class="hljs-keyword">return</span> y.num == <span class="hljs-number">0</span> ? lval_err(LERR_DIV_ZERO) : lval_num(x.num / y.num);
  }

  <span class="hljs-keyword">return</span> lval_err(LERR_BAD_OP);
}
</code></pre>
<div class="alert alert-warning">
  <strong>What is that <code>?</code> doing there?</strong>

  You&#39;ll notice that for division to check if the second argument is zero we use a question mark symbol <code>?</code>, followed by a colon <code>:</code>. This is called the <em>ternary operator</em>, and it allows you to write conditional expressions on one line.

  It works something like this. <code>&lt;condition&gt; ? &lt;then&gt; : &lt;else&gt;</code>. In other words, if the condition is true it returns what follows the <code>?</code>, otherwise it returns what follows <code>:</code>.

  Some people dislike this operator because they believe it makes code unclear. If you are unfamiliar with the ternary operator, initially, you may feel awkward to use it; but once you get to know it there are rarely problems.
</div>

<p>We need to give a similar treatment to our <code>eval</code> function. In this case because we&#39;ve defined <code>eval_op</code> to robustly handle errors we just need to add the error conditions to our number conversion function.</p>
<p>In this case we use the <code>strtol</code> function to convert from string to <code>long</code>. This allows us to check a special variable <code>errno</code> to ensure the conversion goes correctly. This is a more robust way to convert numbers than our previous method using <code>atoi</code>.</p>
<pre><code class="lang-c">lval eval(mpc_ast_t* t) {

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(t-&gt;tag, <span class="hljs-string">"number"</span>)) {
    <span class="hljs-comment">/* Check if there is some error in conversion */</span>
    <span class="hljs-keyword">long</span> x = strtol(t-&gt;contents, NULL, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">return</span> errno != ERANGE ? lval_num(x) : lval_err(LERR_BAD_NUM);
  }

  <span class="hljs-keyword">char</span>* op = t-&gt;children[<span class="hljs-number">1</span>]-&gt;contents;
  lval x = eval(t-&gt;children[<span class="hljs-number">2</span>]);

  <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>;
  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">strstr</span>(t-&gt;children[i]-&gt;tag, <span class="hljs-string">"expr"</span>)) {
    x = eval_op(x, op, eval(t-&gt;children[i]));
    i++;
  }

  <span class="hljs-keyword">return</span> x;
}
</code></pre>
<p>The final small step is to change how we print the result found by our evaluation to use our newly defined printing function which can print any type of <code>lval</code>.</p>
<pre><code class="lang-c">lval result = eval(r.output);
lval_println(result);
mpc_ast_delete(r.output);
</code></pre>
<p>And we are done! Try running this new program and make sure there are no crashes when dividing by zero!</p>
<pre><code class="lang-lispy">lispy&gt; / 10 0
Error: Division By Zero!
lispy&gt; / 10 2
5
</code></pre>
<h2 id="plumbing">Plumbing</h2>
<p><img src="img/plumbing.png" alt="plumbing" title="Plumbing &bull; Harder than you think"></p>
<p>Some of you who have gotten this far in the book may feel uncomfortable with how it is progressing. You may feel you&#39;ve managed to follow instructions well enough, but don&#39;t have a clear understanding of all of the underlying mechanisms going on behind the scenes.</p>
<p>If this is the case I want to reassure you that you are doing well. If you don&#39;t understand the internals it&#39;s because I have not explained everything in sufficient depth. This is okay.</p>
<p>To be able to progress and get code to work under these conditions is a really great skill in programming, and if you&#39;ve made it this far it shows you have it.</p>
<p>In programming we call this <em>plumbing</em>. Roughly speaking this is following instructions to try and tie together a bunch libraries or components, without fully understanding how they work internally.</p>
<p>It requires <em>faith</em> and <em>intuition</em>. <em>Faith</em> is required to believe that if the stars align, and every incantation is correctly performed for this magical machine, the right thing will really happen. And <em>intuition</em> is required to work out what has gone wrong, and how to fix things when they don&#39;t go as planned.</p>
<p>Unfortunately these can&#39;t be taught directly, so if you&#39;ve made it this far then <em>congratulations!</em> You&#39;ve made it over a difficult hump, and in the following chapters I promise we&#39;ll finish up with the plumbing, and actually start to programming that feels fresh and wholesome.</p>
<h2 id="reference">Reference</h2>
<div class="panel-group alert alert-warning" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
          error_handling.c
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse">
      <div class="panel-body">
<code>c
#include &quot;mpc.h&quot;

#ifdef _WIN32

static char buffer[2048];

char* readline(char* prompt) {
  fputs(&quot;lispy&gt; &quot;, stdout);
  fgets(buffer, 2048, stdin);
  char* cpy = malloc(strlen(buffer)+1);
  strcpy(cpy, buffer);
  cpy[strlen(cpy)-1] = &#39;\0&#39;;
  return cpy;
}

void add_history(char* unused) {}

#else

#include &lt;editline/readline.h&gt;
#include &lt;editline/history.h&gt;

#endif

/* Create Enumeration of Possible Error Types */
enum { LERR_DIV_ZERO, LERR_BAD_OP, LERR_BAD_NUM };

/* Create Enumeration of Possible lval Types */
enum { LVAL_NUM, LVAL_ERR };

/* Declare New lval Struct */
typedef struct {
  int type;
  long num;
  int err;
} lval;

/* Create a new number type lval */
lval lval_num(long x) {
  lval v;
  v.type = LVAL_NUM;
  v.num = x;
  return v;
}

/* Create a new error type lval */
lval lval_err(int x) {
  lval v;
  v.type = LVAL_ERR;
  v.err = x;
  return v;
}

/* Print an &quot;lval&quot; */
void lval_print(lval v) {
  switch (v.type) {
    /* In the case the type is a number print it, then &#39;break&#39; out of the switch. */
    case LVAL_NUM: printf(&quot;%li&quot;, v.num); break;

    /* In the case the type is an error */
    case LVAL_ERR:
      /* Check What exact type of error it is and print it */
      if (v.err == LERR_DIV_ZERO) { printf(&quot;Error: Division By Zero!&quot;); }
      if (v.err == LERR_BAD_OP)   { printf(&quot;Error: Invalid Operator!&quot;); }
      if (v.err == LERR_BAD_NUM)  { printf(&quot;Error: Invalid Number!&quot;); }
    break;
  }
}

/* Print an &quot;lval&quot; followed by a newline */
void lval_println(lval v) { lval_print(v); putchar(&#39;\n&#39;); }

lval eval_op(lval x, char* op, lval y) {

  /* If either value is an error return it */
  if (x.type == LVAL_ERR) { return x; }
  if (y.type == LVAL_ERR) { return y; }

  /* Otherwise do maths on the number values */
  if (strcmp(op, &quot;+&quot;) == 0) { return lval_num(x.num + y.num); }
  if (strcmp(op, &quot;-&quot;) == 0) { return lval_num(x.num - y.num); }
  if (strcmp(op, &quot;*&quot;) == 0) { return lval_num(x.num * y.num); }
  if (strcmp(op, &quot;/&quot;) == 0) {
    /* If second operand is zero return error instead of result */
    return y.num == 0 ? lval_err(LERR_DIV_ZERO) : lval_num(x.num / y.num);
  }

  return lval_err(LERR_BAD_OP);
}

lval eval(mpc_ast_t* t) {

  if (strstr(t-&gt;tag, &quot;number&quot;)) {
    /* Check if there is some error in conversion */
    long x = strtol(t-&gt;contents, NULL, 10);
    return errno != ERANGE ? lval_num(x) : lval_err(LERR_BAD_NUM);
  }

  char* op = t-&gt;children[1]-&gt;contents;
  lval x = eval(t-&gt;children[2]);

  int i = 3;
  while (strstr(t-&gt;children[i]-&gt;tag, &quot;expr&quot;)) {
    x = eval_op(x, op, eval(t-&gt;children[i]));
    i++;
  }

  return x;
}

int main(int argc, char** argv) {

  mpc_parser_t* Number = mpc_new(&quot;number&quot;);
  mpc_parser_t* Operator = mpc_new(&quot;operator&quot;);
  mpc_parser_t* Expr = mpc_new(&quot;expr&quot;);
  mpc_parser_t* Lispy = mpc_new(&quot;lispy&quot;);

  mpca_lang(MPC_LANG_DEFAULT,
    &quot;                                                     \
      number   : /-?[0-9]+/ ;                             \
      operator : &#39;+&#39; | &#39;-&#39; | &#39;*&#39; | &#39;/&#39; ;                  \
      expr     : &lt;number&gt; | &#39;(&#39; &lt;operator&gt; &lt;expr&gt;+ &#39;)&#39; ;  \
      lispy    : /^/ &lt;operator&gt; &lt;expr&gt;+ /$/ ;             \
    &quot;,
    Number, Operator, Expr, Lispy);

  puts(&quot;Lispy Version 0.0.0.0.4&quot;);
  puts(&quot;Press Ctrl+c to Exit\n&quot;);

  while (1) {

    char* input = readline(&quot;lispy&gt; &quot;);
    add_history(input);

    mpc_result_t r;
      if (mpc_parse(&quot;&lt;stdin&gt;&quot;, input, Lispy, &amp;r)) {

      lval result = eval(r.output);
      lval_println(result);
      mpc_ast_delete(r.output);

    } else {
      mpc_err_print(r.error);
      mpc_err_delete(r.error);
    }

    free(input);

  }

  mpc_cleanup(4, Number, Operator, Expr, Lispy);

  return 0;
}</code>
      </div>
    </div>
  </div>
</div>

<h2 id="bonus-marks">Bonus Marks</h2>
<div class="alert alert-warning">
  <ul class="list-group">
    <li class="list-group-item">&rsaquo; How do you give an <code>enum</code> a name?</li>
    <li class="list-group-item">&rsaquo; What are <code>union</code> data types and how do they work?</li>
    <li class="list-group-item">&rsaquo; Can you change how <code>lval</code> is defined to use <code>union</code> instead of <code>struct</code>?</li>
    <li class="list-group-item">&rsaquo; What are the advantages over using a <code>union</code> instead of <code>struct</code>?</li>
    <li class="list-group-item">&rsaquo; Extend parsing and evaluation to support the remainder operator <code>%</code>.</li>
    <li class="list-group-item">&rsaquo; Extend parsing and evaluation to support decimal types using a <code>double</code> field.</li>
  </ul>
</div>
                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="./evaluation.html" class="navigation navigation-prev " aria-label="Previous page: Evaluation"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./s_expressions.html" class="navigation navigation-next " aria-label="Next page: S-Expressions"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
