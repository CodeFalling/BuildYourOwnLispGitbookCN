<!DOCTYPE HTML>
<html lang="en-US" manifest="./manifest.appcache">
    
    <head>
        
        <meta charset="UTF-8">
        <title>Evaluation | 介绍</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 0.7.1">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <meta name="author" content="CodeFalling">
    
    
    <link rel="next" href="./error_handling.html" />
    
    
    <link rel="prev" href="./parsing.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="gitbook/style.css">


        
    <div class="book" data-github="CodeFalling/BuildYourOwnLispGitbookCN" data-level="6" data-basepath="." data-revision="1407550346258">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/CodeFalling/BuildYourOwnLispGitbookCN" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="./" >介绍</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        <li>
            <a href="https://github.com/CodeFalling" target="blank" class="author-link">About the author</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/CodeFalling/BuildYourOwnLispGitbookCN/issues" target="blank" class="issues-link">Questions and Issues</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/CodeFalling/BuildYourOwnLispGitbookCN/edit/master/evaluation.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

	

        
        <li class="divider"></li>
        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="installation.html">
            
                
                    <a href="./installation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Installation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="basics.html">
            
                
                    <a href="./basics.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Basics
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="interactive_prompt.html">
            
                
                    <a href="./interactive_prompt.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Interactive Prompt
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="languages.html">
            
                
                    <a href="./languages.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Languages
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="parsing.html">
            
                
                    <a href="./parsing.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Parsing
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="6" data-path="evaluation.html">
            
                
                    <a href="./evaluation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         Evaluation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="error_handling.html">
            
                
                    <a href="./error_handling.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         Error Handling
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="s_expressions.html">
            
                
                    <a href="./s_expressions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         S-Expressions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="q_expressions.html">
            
                
                    <a href="./q_expressions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         Q-Expressions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="variables.html">
            
                
                    <a href="./variables.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         Variables
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="functions.html">
            
                
                    <a href="./functions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         Functions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="conditionals.html">
            
                
                    <a href="./conditionals.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         Conditionals
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="strings.html">
            
                
                    <a href="./strings.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         Strings
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="standard_library.html">
            
                
                    <a href="./standard_library.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         Standard Library
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="bonus_projects.html">
            
                
                    <a href="./bonus_projects.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         Bonus Projects
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="faq.html">
            
                
                    <a href="./faq.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         FAQ
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="credits.html">
            
                
                    <a href="./credits.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         Credits
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 35.294117647058826%;min-width: 29.41176470588235%;"></div>
    </div>
    <div class="chapters">
    
        <a href="./index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="./installation.html" title="Installation" class="chapter done new-chapter" data-progress="1" style="left: 5.882352941176471%;"></a>
    
        <a href="./basics.html" title="Basics" class="chapter done new-chapter" data-progress="2" style="left: 11.764705882352942%;"></a>
    
        <a href="./interactive_prompt.html" title="Interactive Prompt" class="chapter done new-chapter" data-progress="3" style="left: 17.647058823529413%;"></a>
    
        <a href="./languages.html" title="Languages" class="chapter done new-chapter" data-progress="4" style="left: 23.529411764705884%;"></a>
    
        <a href="./parsing.html" title="Parsing" class="chapter done new-chapter" data-progress="5" style="left: 29.41176470588235%;"></a>
    
        <a href="./evaluation.html" title="Evaluation" class="chapter done new-chapter" data-progress="6" style="left: 35.294117647058826%;"></a>
    
        <a href="./error_handling.html" title="Error Handling" class="chapter  new-chapter" data-progress="7" style="left: 41.1764705882353%;"></a>
    
        <a href="./s_expressions.html" title="S-Expressions" class="chapter  new-chapter" data-progress="8" style="left: 47.05882352941177%;"></a>
    
        <a href="./q_expressions.html" title="Q-Expressions" class="chapter  new-chapter" data-progress="9" style="left: 52.94117647058823%;"></a>
    
        <a href="./variables.html" title="Variables" class="chapter  " data-progress="10" style="left: 58.8235294117647%;"></a>
    
        <a href="./functions.html" title="Functions" class="chapter  " data-progress="11" style="left: 64.70588235294117%;"></a>
    
        <a href="./conditionals.html" title="Conditionals" class="chapter  " data-progress="12" style="left: 70.58823529411765%;"></a>
    
        <a href="./strings.html" title="Strings" class="chapter  " data-progress="13" style="left: 76.47058823529412%;"></a>
    
        <a href="./standard_library.html" title="Standard Library" class="chapter  " data-progress="14" style="left: 82.3529411764706%;"></a>
    
        <a href="./bonus_projects.html" title="Bonus Projects" class="chapter  " data-progress="15" style="left: 88.23529411764706%;"></a>
    
        <a href="./faq.html" title="FAQ" class="chapter  " data-progress="16" style="left: 94.11764705882354%;"></a>
    
        <a href="./credits.html" title="Credits" class="chapter  " data-progress="17" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_8">
                    
                        <h1 id="evaluation">Evaluation</h1>
<h2 id="trees">Trees</h2>
<p>Now we can read input, and we have it structured internally, but we are still unable to evaluate it. In this chapter we add the code that evaluates this structure and actually performs the computations encoded within.</p>
<p>This internal structure is what we saw printed out by the program in the previous chapter. It is called an <em>Abstract Syntax Tree</em>, and it represents the structure of the program based on the input entered by the user. At the leaves of this tree are numbers and operators - the actual data to be processed. At the branches are the rules used to produce this part of the tree - the information on how to traverse and evaluate it.</p>
<p><img src="img/tree.png" alt="tree" title="Abstract Christmas Tree &bull; A seasonal variation"></p>
<p>Before working out exactly how we are going to do this traversal, lets see exactly how this structure is defined internally. If we peek inside <code>mpc.h</code> we can have a look at the definition of <code>mpc_ast_t</code>, which is the data structure we got from the parse.</p>
<pre><code class="lang-c"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> mpc_ast_t {
  <span class="hljs-keyword">char</span>* tag;
  <span class="hljs-keyword">char</span>* contents;
  <span class="hljs-keyword">int</span> children_num;
  <span class="hljs-keyword">struct</span> mpc_ast_t** children;
} mpc_ast_t;
</code></pre>
<p>This struct has a number of fields we can access. Lets take a look at them one by one.</p>
<p>The first field is <code>tag</code>. When we printed out the tree this was the information that precluded the contents of the node. It was a string containing a list of all the rules used to parse that particular item. For example <code>expr|number|regex</code>.</p>
<p>This <code>tag</code> field is going to be important as it lets us see what type of thing the node is.</p>
<p>The second field is <code>contents</code>. This will contain the actual contents of the node such as <code>&#39;*&#39;</code>, <code>&#39;(&#39;</code> or <code>&#39;5&#39;</code>. You&#39;ll notice for branches this is empty, but for leaves we can use it to find the operator or number to use.</p>
<p>Finally we see two fields that are going to help us traverse the tree. These are <code>children_num</code> and <code>children</code>. The first field tells us how many children a node has, and the second is an array of these children.</p>
<p>The type of the <code>children</code> field is <code>mpc_ast_t**</code>. This is a double pointer type. It isn&#39;t as scary as it looks and will be explained in greater detail in later chapters. For now you can think of it as a list of the child nodes of the this tree.</p>
<p>We can access a child node, by accessing this field using array notation. This is done by writing the field name <code>children</code> and suffixing it with square brackets containing the index of the child to access. For example to access the first child of the node we can use <code>children[0]</code>. Notice that C counts its array indices from <code>0</code>.</p>
<p>Because the type <code>mpc_ast_t*</code> is a <em>pointer</em> to a struct, there is a slightly different syntax to access its fields. We need to use an arrow <code>-&gt;</code> instead of a dot <code>.</code>. There is no fundamental reason for this switch in operators, so for now just remember that field access of pointer types uses an arrow.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Load AST from output */</span>
mpc_ast_t* a = r.output;
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Tag: %s\n"</span>, a-&gt;tag);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Contents: %s\n"</span>, a-&gt;contents);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Number of children: %i\n"</span>, a-&gt;children_num);

<span class="hljs-comment">/* Get First Child */</span>
mpc_ast_t* c0 = a-&gt;children[<span class="hljs-number">0</span>];
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"First Child Tag: %s\n"</span>, c0-&gt;tag);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"First Child Contents: %s\n"</span>, c0-&gt;contents);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"First Child Number of children: %i\n"</span>, c0-&gt;children_num);
</code></pre>
<h2 id="recursion">Recursion</h2>
<p>There is a funny thing about this tree structure. It refers to itself. Each of its children are themselves trees again, and the children of those children are trees yet again. Just like our languages, and re-write rules, data in this structure contains repeated substructures, that resemble their parents.</p>
<p><img src="img/recursion.png" alt="recursion" title="Recursion &bull; Dangerous in a fire"></p>
<p>This pattern of repeated substructures could go on and on. Clearly if we want a function which can work on all possible trees we can&#39;t look just a couple of nodes down, we have to define it to work on trees of any depth.</p>
<p>Luckily we can do this, by exploiting the nature of how these substructures repeat, and using a technique called <em>recursion</em>.</p>
<p>Put simply a <em>recursive function</em> is one that calls itself as some part of its calculation.</p>
<p>It sounds weird for a function to be defined in terms of itself. But consider that functions can give different outputs when supplied with different inputs. If we give some changed, or different inputs to a recursive call to the same function, and provide a way for this function to not call itself again under certain conditions, we can be more confident this <em>recursive function</em> is doing something useful.</p>
<p>As an example we can write a recursive function which will count the number of nodes in our tree structure.</p>
<p>To begin we work out how it will act in the most simple case, if the input tree has no children. In this case we know the result is simply one. Now we can go on to define the more complex case, if the tree has one or more children. In this case the result will be one (for the node itself), plus the number of nodes in all of those children.</p>
<p>But how do we find the number of nodes in all of the children? Well we can use the function we are in the process defining! <em>Yeah, Recursion.</em></p>
<p>In C we might write it something like this.</p>
<pre><code class="lang-c"><span class="hljs-keyword">int</span> number_of_nodes(mpc_ast_t* t) {
  <span class="hljs-keyword">if</span> (t-&gt;children_num == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; }
  <span class="hljs-keyword">if</span> (t-&gt;children_num &gt;= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">int</span> total = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; t-&gt;children_num; i++) {
      total = total + number_of_nodes(t-&gt;children[i]);
    }
    <span class="hljs-keyword">return</span> total;
  }
}
</code></pre>
<p>Recursive functions are weird because they require an odd leap of faith. First we have to assume we have some function which does something correctly already, and then we have to go about using this function, to write the initial function we assumed we had!</p>
<p>Like most things, recursive functions almost always end up following a similar pattern. First a <em>base case</em> is defined. This is the case that ends the recursion, such as <code>t-&gt;children_num == 0</code> in our previous example. After this the <em>recursive case</em> is defined, such as <code>t-&gt;children_num &gt;= 1</code> in our previous example, which breaks down a computation into smaller parts, and calls itself recursively to compute those parts, before combining them together.</p>
<p>Recursive functions can take some thought, so pause now and ensure you understand them before continuing onto other chapters because we&#39;ll be making good use of them in the rest of the book. If you are still uncertain, you can check out some of the bonus marks for this chapter to practice.</p>
<h2 id="evaluation">Evaluation</h2>
<p>To evaluate the parse tree we are going to write a recursive function. But before we get started, let us try and see what observations we can make about the structure of the tree we get as input. Try printing out some expressions using your program from the previous chapter. See what you can notice.</p>
<pre><code class="lang-lispy">lispy&gt; + 1 (* 5 4)
&gt;:
  regex:
  operator|char: &#39;+&#39;
  expr|number|regex: &#39;1&#39;
  expr|&gt;:
    char: &#39;(&#39;
    operator|char: &#39;*&#39;
    expr|number|regex: &#39;5&#39;
    expr|number|regex: &#39;4&#39;
    char: &#39;)&#39;
  regex:
</code></pre>
<p>One observation is that if a node is tagged with <code>number</code> it is always a number, has no children, and we can just convert the contents to an integer. This will act as the <em>base case</em> in our recursion.</p>
<p>If a node is tagged with <code>expr</code>, and is <em>not</em> a <code>number</code>, we need to look at its second child (the first child is always <code>&#39;(&#39;</code>) and see which operator it is. Then we need to apply this operator to the <em>evaluation</em> of the remaining children, excluding the final child which is always <code>&#39;)&#39;</code>. This is our <em>recursive case</em>. This also needs to be done for the root node.</p>
<p>When we evaluate our tree, just like when counting the nodes, we&#39;ll need to accumulate the result. To represent this result we&#39;ll use the C type <code>long</code> which means a <em>long</em> <em>integer</em>.</p>
<p>To detect the tag of a node, or to get a number from a node, we will need to make use of the <code>tag</code> and <code>contents</code> fields. These are <em>string</em> fields, so we are going to have to learn a couple of string functions first.</p>
<table class='table'>
  <tr><td><code>atoi</code></td><td>Converts a <code>char*</code> to a <code>long</code>.</td></tr>
  <tr><td><code>strcmp</code></td><td>Takes as input two <code>char*</code> and if they are equal it returns <code>0</code>.</td></tr>
  <tr><td><code>strstr</code></td><td>Takes as input two <code>char*</code> and returns a pointer to the location of the second in the first, or <code>0</code> if the second is not a sub-string of the first.</td></tr>
</table>

<p>We can use <code>strcmp</code> to check which operator to use, and <code>strstr</code> to check if a tag contains some substring. Altogether our recursive evaluation function looks like this.</p>
<pre><code class="lang-c"><span class="hljs-keyword">long</span> eval(mpc_ast_t* t) {

  <span class="hljs-comment">/* If tagged as number return it directly, otherwise expression. */</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(t-&gt;tag, <span class="hljs-string">"number"</span>)) { <span class="hljs-keyword">return</span> atoi(t-&gt;contents); }

  <span class="hljs-comment">/* The operator is always second child. */</span>
  <span class="hljs-keyword">char</span>* op = t-&gt;children[<span class="hljs-number">1</span>]-&gt;contents;

  <span class="hljs-comment">/* We store the third child in `x` */</span>
  <span class="hljs-keyword">long</span> x = eval(t-&gt;children[<span class="hljs-number">2</span>]);

  <span class="hljs-comment">/* Iterate the remaining children, combining using our operator */</span>
  <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>;
  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">strstr</span>(t-&gt;children[i]-&gt;tag, <span class="hljs-string">"expr"</span>)) {
    x = eval_op(x, op, eval(t-&gt;children[i]));
    i++;
  }

  <span class="hljs-keyword">return</span> x;
}
</code></pre>
<p>We can define the <code>eval_op</code> function as follows. It takes in a number, an operator string, and another number. It tests for which operator is passed in, an performs the corresponding C operation on the inputs.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* Use operator string to see which operation to perform */</span>
<span class="hljs-keyword">long</span> eval_op(<span class="hljs-keyword">long</span> x, <span class="hljs-keyword">char</span>* op, <span class="hljs-keyword">long</span> y) {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"+"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> x + y; }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"-"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> x - y; }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"*"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> x * y; }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(op, <span class="hljs-string">"/"</span>) == <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> x / y; }
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 id="printing">Printing</h2>
<p>Instead of printing the tree we now want to print the result of the evaluation. Therefore we need to pass the tree into our <code>eval</code> function, and print the result we get using <code>printf</code> and the specifier <code>%li</code>, which is used for <code>long</code> type.</p>
<p>We also need to remember to delete the output tree after we are done evaluating it.</p>
<pre><code class="lang-c"><span class="hljs-keyword">long</span> result = eval(r.output);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%li\n"</span>, result);
mpc_ast_delete(r.output);
</code></pre>
<p>If all of this is successful we should be able to do some basic maths with our new programming language!</p>
<pre><code class="lang-lispy">Lispy Version 0.0.0.0.3
Press Ctrl+c to Exit

lispy&gt; + 5 6
11
lispy&gt; - (* 10 10) (+ 1 1 1)
97
lispy&gt; - (/ 10 2) 20
-15
lispy&gt;
</code></pre>
<h2 id="reference">Reference</h2>
<div class="panel-group alert alert-warning" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
          evaluation.c
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse">
      <div class="panel-body">
<code>c
#include &quot;mpc.h&quot;

#ifdef _WIN32

static char buffer[2048];

char* readline(char* prompt) {
  fputs(&quot;lispy&gt; &quot;, stdout);
  fgets(buffer, 2048, stdin);
  char* cpy = malloc(strlen(buffer)+1);
  strcpy(cpy, buffer);
  cpy[strlen(cpy)-1] = &#39;\0&#39;;
  return cpy;
}

void add_history(char* unused) {}

#else

#include &lt;editline/readline.h&gt;
#include &lt;editline/history.h&gt;

#endif

/* Use operator string to see which operation to perform */
long eval_op(long x, char* op, long y) {
  if (strcmp(op, &quot;+&quot;) == 0) { return x + y; }
  if (strcmp(op, &quot;-&quot;) == 0) { return x - y; }
  if (strcmp(op, &quot;*&quot;) == 0) { return x * y; }
  if (strcmp(op, &quot;/&quot;) == 0) { return x / y; }
  return 0;
}

long eval(mpc_ast_t* t) {

  /* If tagged as number return it directly, otherwise expression. */
  if (strstr(t-&gt;tag, &quot;number&quot;)) { return atoi(t-&gt;contents); }

  /* The operator is always second child. */
  char* op = t-&gt;children[1]-&gt;contents;

  /* We store the third child in `x` */
  long x = eval(t-&gt;children[2]);

  /* Iterate the remaining children, combining using our operator */
  int i = 3;
  while (strstr(t-&gt;children[i]-&gt;tag, &quot;expr&quot;)) {
    x = eval_op(x, op, eval(t-&gt;children[i]));
    i++;
  }

  return x;
}

int main(int argc, char** argv) {

  mpc_parser_t* Number = mpc_new(&quot;number&quot;);
  mpc_parser_t* Operator = mpc_new(&quot;operator&quot;);
  mpc_parser_t* Expr = mpc_new(&quot;expr&quot;);
  mpc_parser_t* Lispy = mpc_new(&quot;lispy&quot;);

  mpca_lang(MPC_LANG_DEFAULT,
    &quot;                                                     \
      number   : /-?[0-9]+/ ;                             \
      operator : &#39;+&#39; | &#39;-&#39; | &#39;*&#39; | &#39;/&#39; ;                  \
      expr     : &lt;number&gt; | &#39;(&#39; &lt;operator&gt; &lt;expr&gt;+ &#39;)&#39; ;  \
      lispy    : /^/ &lt;operator&gt; &lt;expr&gt;+ /$/ ;             \
    &quot;,
    Number, Operator, Expr, Lispy);

  puts(&quot;Lispy Version 0.0.0.0.3&quot;);
  puts(&quot;Press Ctrl+c to Exit\n&quot;);

  while (1) {

    char* input = readline(&quot;lispy&gt; &quot;);
    add_history(input);

    mpc_result_t r;
    if (mpc_parse(&quot;&lt;stdin&gt;&quot;, input, Lispy, &amp;r)) {

      long result = eval(r.output);
      printf(&quot;%li\n&quot;, result);
      mpc_ast_delete(r.output);

    } else {
      mpc_err_print(r.error);
      mpc_err_delete(r.error);
    }

    free(input);

  }

  mpc_cleanup(4, Number, Operator, Expr, Lispy);

  return 0;
}&lt;</code>
      </div>
    </div>
  </div>
</div>

<h2 id="bonus-marks">Bonus Marks</h2>
<div class="alert alert-warning">
  <ul class="list-group">
    <li class="list-group-item">&rsaquo; Write a recursive function to compute the number of leaves of a tree.</li>
    <li class="list-group-item">&rsaquo; Write a recursive function to compute the number of branches of a tree.</li>
    <li class="list-group-item">&rsaquo; Write a recursive function to compute the most number of children spanning from one branch of a tree.</li>
    <li class="list-group-item">&rsaquo; How would you use <code>strstr</code> to see if a node was tagged as an <code>expr</code>.</li>
    <li class="list-group-item">&rsaquo; How would you use <code>strcmp</code> to see if a node had the contents <code>&#39;(&#39;</code> or <code>&#39;)&#39;</code>.</li>
    <li class="list-group-item">&rsaquo; Add the operator <code>%</code>, which returns the remainder of division. For example <code>% 10 6</code> is <code>4</code>.</li>
    <li class="list-group-item">&rsaquo; Add the operator <code>^</code>, which raises one number to another. For example <code>^ 4 2</code> is <code>16</code>.</li>
    <li class="list-group-item">&rsaquo; Add the function <code>min</code>, which returns the smallest number. For example <code>min 1 5 3</code> is <code>1</code>.</li>
    <li class="list-group-item">&rsaquo; Add the function <code>max</code>, which returns the biggest number. For example <code>max 1 5 3</code> is <code>5</code>.</li>
    <li class="list-group-item">&rsaquo; Change the minus operator <code>-</code> so that when it receives one argument it negates it.</li>
  </ul>
</div>
                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="./parsing.html" class="navigation navigation-prev " aria-label="Previous page: Parsing"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./error_handling.html" class="navigation navigation-next " aria-label="Next page: Error Handling"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
